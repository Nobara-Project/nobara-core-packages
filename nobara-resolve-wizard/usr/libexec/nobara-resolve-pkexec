#!/bin/python3

import os
import subprocess
import sys
from pathlib import Path
import shutil
import stat

LIBDIR = Path("/opt/resolve/libs")
RUNTIME_DIR = Path("/opt/nobara-resolve-runtime")

# Check if the correct number of arguments were provided
if len(sys.argv) != 2:
    print("Usage: python script.py <run_file>")
    sys.exit(1)

run_file = sys.argv[1]

# Step 1: Install necessary packages as root
subprocess.run(["dnf", "install", "-y", "rocm-meta", "nobara-resolve-runtime", "zlib", "libxcrypt-compat", "python3.11", "python3.11-libs", "alsa-plugins-pulseaudio"], check=True)

# Step 2: Remove old version if it exists
os.chmod(run_file, 0o775)
subprocess.run(["bash", "-c", f"SKIP_PACKAGE_CHECK=1 {run_file} -u -y -a"], check=True)

# Step 3: Run the .run file as the user
subprocess.run(["bash", "-c", f"SKIP_PACKAGE_CHECK=1 {run_file} -i -r -y -a"], check=True)

# Step 4: Fix broken resolve-shipped libraries
# Remove the resolve-shipped libs that conflict
for pattern in ("libglib-*", "libgobject-*", "libgmodule-*", "libgio-*"):
    for p in LIBDIR.glob(pattern):
        try:
            if p.is_dir():
                shutil.rmtree(p)  # just in case a directory matches
            else:
                p.unlink()
        except FileNotFoundError:
            pass  # already gone
        except PermissionError as e:
            print(f"Permission error removing {p}: {e}")

# Copy the system-provided .so.* files into Resolve's lib directory
for sofile in RUNTIME_DIR.glob("*.so.*"):
    try:
        shutil.copy2(sofile, LIBDIR / sofile.name)
    except PermissionError as e:
        print(f"Permission error copying {sofile}: {e}")

# Paths
orig = "/opt/resolve/bin/resolve"
real = "/opt/resolve/bin/resolve-real"

# 1. Move original binary to resolve-real
shutil.move(orig, real)

# 2. Create the wrapper script
wrapper_content = """#!/bin/bash
export LD_PRELOAD=/usr/lib64/libpython3.11.so.1.0
exec /opt/resolve/bin/resolve-real "$@"
"""

with open(orig, "w") as f:
    f.write(wrapper_content)

# 3. Make the wrapper executable (chmod +x)
st = os.stat(orig)
os.chmod(orig, st.st_mode | stat.S_IXUSR | stat.S_IXGRP | stat.S_IXOTH)
